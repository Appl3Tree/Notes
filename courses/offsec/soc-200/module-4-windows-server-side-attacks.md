# Module 4: Windows Server Side Attacks

## Credential Abuse

### The Security Account Manager (SAM) and Windows Authentication

On Windows, hashed passwords are stored in the Security Account Manager (SAM) database. To deter offline SAM database password attacks, Microsoft introduced the SYSKEY feature, which partially encrypts the SAM file. Though it was successful, it has been discontinued since the encryption key length is considered insecure.

{% hint style="info" %}
SYSKEY was also being used for ransomware scams. Microsoft has since recommended [BitLocker](https://en.wikipedia.org/wiki/BitLocker) as an alternative to SYSKEY to protect not only the SAM but entire [hard drive volumes](https://en.wikipedia.org/wiki/Volume_\(computing\)).
{% endhint %}

Windows NT-based OS', up to and included Windows 20023 store two different password hashes: LAN Manager (LM), which is based on Data Encrypt Standard (DES), and NT LAN Manager (NTLM), which uses MD4 hashing.

LAN Manager is very weak since passwords longer than seven characters are split into two strings and each piece is hashed separately. They are also converted to all upper-case characters before hashing, and does not include salt, making a hash-lookup attack feasible.

Starting in Vista, LM is disabled by default, using NTLM. Unfortunately, NTLM is still not salted.

Authentication occurs by converting a user's password into a hash via Local Security Authority (LSA) and is then compared to the one stored in the system's SAM.

### Suspicious Logins

_Potentially Suspicious Logon Event during Off-Hours_

{% code overflow="wrap" %}
```powershell
Get-WinEvent -FilterHashtable @{LogName='Security'; StartTime="4/30/2021 19:00:00"; EndTime="5/3/2021 07:00:00"; ID=4624 }
```
{% endcode %}

_Querying the full details of the identified suspicious logon event_

{% code overflow="wrap" %}
```powershell
[192.168.51.11]: PS C:\Users\Administrator> Get-WinEvent -FilterHashtable @{LogName='Security'; StartTime="5/1/2021 03:21:26"; EndTime="5/1/2021 03:21:27"; ID=4624 } | Format-List

TimeCreated  : 5/1/2021 3:21:26 AM
ProviderName : Microsoft-Windows-Security-Auditing
Id           : 4624
Message      : An account was successfully logged on.
               
...
               
               Logon Information:
                Logon Type:             10
...

               New Logon:
                Security ID:            S-1-5-21-1253842116-4206507704-3578910670-500
                Logon ID:               0x323466
                Account Name:           Administrator
                Account Domain:         SERVER01
...
                Workstation Name:       SERVER01
                Source Network Address: 192.168.51.50
...
```
{% endcode %}

The Logon ID is unique to each session. This can be used to differentiate between two or more administrators. It can also help correlate other events.

_Custom Function Get-SecurityEvent_

```powershell
function Get-SecurityEvent{
    param (
        $eventid,
        $start,
        $end
    )
    $filters = @{LogName = "Security"}
    
    if ($eventid -ne $null) {
        $filters.ID = $eventid
    }
    if ($start -ne $null) {
        $filters.StartTime = $start
    }

    if ($end -ne $null) {
        $filters.EndTime = $end
    }
    Get-WinEvent -FilterHashtable $filters
}
```

_Finding all logoff events after the suspicious Logon event_

{% code overflow="wrap" %}
```powershell
[192.168.51.11]: PS C:\Users\Administrator\Documents> Get-SecurityEvent 4634 "5/1/2021 03:21:26" "5/3/2021 07:00:00" | Where-Object { $_.properties[3].value -eq 0x323466 } | Format-List

TimeCreated  : 5/1/2021 3:21:26 AM
ProviderName : Microsoft-Windows-Security-Auditing
Id           : 4634
Message      : An account was logged off.
               
               Subject:
                Security ID:            S-1-5-21-1253842116-4206507704-3578910670-500
                Account Name:           Administrator
                Account Domain:         SERVER01
                Logon ID:               0x323466
               
               Logon Type:                      10
```
{% endcode %}

### Brute Force Logins

<figure><img src="../../../.gitbook/assets/2b1e9ffd5dd3a58db4f045850988ba41-windows_auth_01.png" alt=""><figcaption><p><em>Events generated by a brute force logon attempt</em></p></figcaption></figure>

_Logon Failure Events from brute force attack_

{% code overflow="wrap" %}
```powershell
[192.168.51.11]: PS C:\Users\Administrator> Get-SecurityEvent 4625 "5/6/2021 00:00:00" "5/7/2021 00:00:00"

   ProviderName: Microsoft-Windows-Security-Auditing
   
TimeCreated                     Id LevelDisplayName Message       
-----------                     -- ---------------- -------
5/6/2021 9:36:49 AM           4625 Information      An account failed to log on....                                                           
5/6/2021 9:36:49 AM           4625 Information      An account failed to log on....                                                           
5/6/2021 9:36:49 AM           4625 Information      An account failed to log on....                                                           
5/6/2021 9:36:49 AM           4625 Information      An account failed to log on....                                                           
5/6/2021 9:36:49 AM           4625 Information      An account failed to log on....                                                           
5/6/2021 9:36:49 AM           4625 Information      An account failed to log on....                                                           
5/6/2021 9:36:49 AM           4625 Information      An account failed to log on....                                                           
5/6/2021 9:36:49 AM           4625 Information      An account failed to log on....                                                           
...
5/6/2021 9:36:44 AM           4625 Information      An account failed to log on.... 
```
{% endcode %}

_Format-List Custom Field with Logon Type for Logon Failure Events_

```powershell
@{Label = "Logon Type"; Expression = {$_.properties[10].value}}
```

_Format-List Custom Fields with User Name, Workstation Name, and IP Address for Logon Failure Events_

```powershell
@{Label = "Target User Name"; Expression = {$_.properties[5].value}}
@{Label = "Workstation Name"; Expression = {$_.properties[13].value}}
@{Label = "IP Address"; Expression = {$_.properties[19].value}}
```

_Format-List Custom Fields with Status and Substatus for Logon Failure Events_

```powershell
@{Label = "Status"; Expression = {'{0:X8}' -f $_.properties[7].value}}
@{Label = "Substatus"; Expression = {'{0:X8}' -f $_.properties[9].value}}
```

{% hint style="info" %}
One of the status codes for a logon failure is C000006F: User logon outside authorized hours. Account policy supports the ability to restrict when user accounts can log in to a system. It is important to note that this restriction cannot be applied to Administrator accounts. But such a configuration can reduce the likelihood of compromised user accounts authenticating during off-hours.
{% endhint %}

_Custom Output for querying Logon Failure Events using Get-SecurityEvent_

{% code overflow="wrap" %}
```powershell
[192.168.51.11]: PS C:\Users\Administrator> Get-SecurityEvent 4625 "5/6/2021 00:00:00" "5/7/2021 00:00:00" | Format-List TimeCreated, @{Label = "Logon Type"; Expression = {$_.properties[10].value}}, @{Label = "Status"; Expression = {'{0:X8}' -f $_.properties[7].value}}, @{Label = "Substatus"; Expression = {'{0:X8}' -f $_.properties[9].value}}, @{Label = "Target User Name"; Expression = {$_.properties[5].value}}, @{Label = "Workstation Name"; Expression = {$_.properties[13].value}}, @{Label = "IP Address"; Expression = {$_.properties[19].value}}

TimeCreated      : 5/6/2021 9:36:49 AM
Logon Type       : 3
Status           : C000006D
Substatus        : C000006A
Target User Name : Administrator
Workstation Name : attacker01
IP Address       : 192.168.51.50

TimeCreated      : 5/6/2021 9:36:49 AM
Logon Type       : 3
Status           : C000006D
Substatus        : C000006A
Target User Name : Administrator
Workstation Name : ATTACKER01
IP Address       : 192.168.51.50
...
TimeCreated      : 5/6/2021 9:36:44 AM
Logon Type       : 3
Status           : C000006D
Substatus        : C000006A
Target User Name : Administrator
Workstation Name : ATTACKER01
IP Address       : 192.168.51.50
```
{% endcode %}

{% hint style="info" %}
NLA is recommended for enterprise networks that support RDP for remote access. It requires later versions of software, reduces the risk of denial-of-service, and in one case thwarts a means of persistence. For more information, look up the Accessibility Features sub-technique of Event Triggered Execution in the MITRE ATT\&CK Framework.
{% endhint %}

_Logon Success after brute force authentication_

{% code overflow="wrap" %}
```powershell
[192.168.51.11]: PS C:\Users\Administrator\Documents> Get-SecurityEvent 4624 "5/6/2021 09:36:44" "5/6/2021 09:37:44" | Where-Object { $_.properties[18].value -eq "192.168.51.50" }

   ProviderName: Microsoft-Windows-Security-Auditing

TimeCreated                     Id LevelDisplayName Message       
-----------                     -- ---------------- -------
5/6/2021 9:36:50 AM           4624 Information      An account was successfully logged on....         
```
{% endcode %}

## Web Application Attacks

### Internet Information Services (IIS)



### Local File Inclusion



### Command Injection



### File Upload



### Extra Mile



## Binary Exploitation

### Binary Attacks



### Windows Defender Exploit Guard (WDEG)



